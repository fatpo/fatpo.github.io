# 1、基础条件

版本:

```
ubuntu 18.04
```

dns：

```
已经添加了IP解析
```

# 2、安装基础组件

```
sudo atp-get install -y nginx
sudo atp-get install -y redis
sudo atp-get install -y supervisor
sudo apt-get install -y mysql-server
```

配置 mysql:

```text
$ mysql -u root

mysql> USE mysql; 
mysql> update user set authentication_string=PASSWORD('your_password_here') where user='root';
mysql> update user set plugin="mysql_native_password" where User='root';
mysql> flush privileges;
mysql> quit
```

# 3、更改 sshd

vi ~/.ssh/authorized_keys

```text
输入自己的公钥
```

vi /etc/ssh/sshd_config:

```text
PasswordAuthentication no
```

重启：

```text
service sshd restart
```

# 4、配置 ufw
一般来说，我们只要开放22,80,443三个端口就够了：
```text
root@ai1:~# ufw status
Status: active

To                         Action      From
--                         ------      ----
22/tcp                     ALLOW       Anywhere
22/tcp (v6)                ALLOW       Anywhere (v6)

root@ai1:~# ufw allow 80
Rule added
Rule added (v6)
root@ai1:~# ufw allow 443
Rule added
Rule added (v6)
root@ai1:~# ufw status
Status: active

To                         Action      From
--                         ------      ----
22/tcp                     ALLOW       Anywhere
80                         ALLOW       Anywhere
443                        ALLOW       Anywhere
22/tcp (v6)                ALLOW       Anywhere (v6)
80 (v6)                    ALLOW       Anywhere (v6)
443 (v6)                   ALLOW       Anywhere (v6)
```

# 5、配置fail2ban
安装fail2ban很简单。登录到您的Ubuntu服务器并更新/升级。请注意，如果在此过程中升级内核，则必须重新启动服务器（因此在重新启动可行时运行此服务器）。

要更新和升级服务器，请发出以下命令：
```
sudo apt-get update
sudo apt-get upgrade
```

完成上述命令后，重新启动服务器（如有必要）。

可以使用单个命令安装fail2ban：
```
sudo apt-get install -y fail2ban
```

当该命令完成时，fail2ban准备好了。您将要使用以下命令启动并启用该服务：
```
sudo systemctl start fail2ban
sudo systemctl enable fail2ban
```

配置jail

接下来我们将为SSH登录尝试配置一个jail。在/etc fail2ban目录中，您将找到jail.conf文件。不要编辑此文件。相反，我们将创建一个新文件jail.local，它将覆盖jail.conf中的任何类似设置。我们的新jail配置将监视/var/log/auth.log，使用fail2ban sshd过滤器，将SSH端口设置为22，并将最大重试次数设置为3.为此，请发出命令：
```
sudo vi /etc/fail2ban/jail.local
```

在此新文件中，粘贴以下内容：
```
[sshd]
enabled = true
port = 22
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
```

保存并关闭该文件。使用以下命令重新启动fail2ban：
```
sudo systemctl restart fail2ban
```

此时，如果有人试图通过SSH登录您的Ubuntu服务器，并且失败了三次，那么将通过iptables阻止其IP地址阻止它们进入。

# 6、配置supervisor 和 nginx

```text
vi  /etc/supervisor/conf.d/smart.conf
vi /etc/nginx/conf.d/smart.conf
```

# 7、把当前服务器的公钥加到 gitlab

如题，照做

# 8、升级pip3，很关键
```text
python3 -m pip install --upgrade pip
```

# 9、升级 https
## 9.1、安装 acme.sh
```text
curl  https://get.acme.sh | sh
source ~/.bashrc
```
设置为自动更新
```text
acme.sh  --upgrade  --auto-upgrade
```

## 9.2、生成证书
```text
acme.sh --issue -d api.haha.xyz --nginx /etc/nginx/conf.d/haha.conf
```

## 9.3、安装证书
```text
acme.sh --install-cert -d api.haha.xyz  \
--key-file /root/.acme.sh/api.haha.xyz/api.haha.xyz.key  \
--fullchain-file  /root/.acme.sh/api.haha.xyz/fullchain.cer  \
--reloadcmd     "nginx -s reload"
```

## 9.4、更新 ng 配置
修改/etc/nginx/conf.d/haha.conf， 添加这一段：
```text
    ssl_certificate   /root/.acme.sh/api.haha.xyz/fullchain.cer;
    ssl_certificate_key  /root/.acme.sh/api.haha.xyz/api.haha.xyz.key;
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
```

总的配置如下：
```text
upstream myapp{
    server 127.0.0.1:8000 weight=1;
}

server {
    listen      80;
    listen [::]:80;

    listen 443 ssl;

    server_name api.haha.xyz;

    ssl_certificate   /root/.acme.sh/api.haha.xyz/fullchain.cer;
    ssl_certificate_key  /root/.acme.sh/api.haha.xyz/api.haha.xyz.key;
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;

    client_max_body_size 20m;

    location ~* \.(html|gif|jpg|jpeg|png|css|js|ico)$ {
        root /root/www/haha/static/;
    }
    location /static/ {
        root /root/www/haha/;
    }

    location ~* ^/haha_api/ {
        proxy_set_header        REMOTE_ADDR     $proxy_add_x_forwarded_for;

        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT, X-Mx-ReqToken, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type, Authorization';

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        proxy_set_header   Host             $host:8000;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_set_header   Cookies          $http_cookies;
        proxy_pass http://myapp;
    }
}
```